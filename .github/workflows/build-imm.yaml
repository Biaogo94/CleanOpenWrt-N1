name: Build ImmortalWrt for Phicomm N1

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'å†…æ ¸ç‰ˆæœ¬ (æ¨è 6.1)'
        required: true
        default: '6.1'
        type: choice
        options:
          - '5.15'
          - '6.1'

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: æœ€å¤§åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 1024
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        
    - name: æ£€æŸ¥åˆå§‹ç£ç›˜ç©ºé—´
      run: |
        echo "åˆå§‹ç£ç›˜ç©ºé—´ï¼š"
        df -hT $GITHUB_WORKSPACE
        
    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
        git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
        libmpc-dev libmpfr-dev libncurses5-dev libreadline-dev libssl-dev libtool lrzsz \
        mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip libpython3-dev qemu-utils \
        rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        echo "å®‰è£…ä¾èµ–åç£ç›˜ç©ºé—´ï¼š"
        df -hT $GITHUB_WORKSPACE
        
    - name: å…‹éš† ImmortalWrt æºç 
      run: |
        cd $GITHUB_WORKSPACE
        git clone -b openwrt-23.05 --single-branch --filter=blob:none https://github.com/immortalwrt/immortalwrt
        
    - name: æ›´æ–° feeds
      run: |
        cd $GITHUB_WORKSPACE/immortalwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: æ·»åŠ  PassWall å’Œ OpenClash
      run: |
        cd $GITHUB_WORKSPACE/immortalwrt
        
        # æ·»åŠ  PassWall
        echo "src-git passwall_packages https://github.com/xiaorouji/openwrt-passwall-packages.git;main" >> feeds.conf.default
        echo "src-git passwall https://github.com/xiaorouji/openwrt-passwall.git;main" >> feeds.conf.default
        
        # æ·»åŠ  OpenClash
        mkdir -p package/luci-app-openclash
        cd package/luci-app-openclash
        git init
        git remote add -f origin https://github.com/vernesong/OpenClash.git
        git config core.sparsecheckout true
        echo "luci-app-openclash" >> .git/info/sparse-checkout
        git pull --depth 1 origin master
        cd ../..
        
        # é‡æ–°æ›´æ–° feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: ç”Ÿæˆç²¾ç®€é…ç½®
      run: |
        cd $GITHUB_WORKSPACE/immortalwrt
        cat > .config <<EOF
        CONFIG_TARGET_armvirt=y
        CONFIG_TARGET_armvirt_64=y
        CONFIG_TARGET_armvirt_64_Default=y
        
        # åŸºç¡€ç³»ç»Ÿ
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-ssl-openssl=y
        CONFIG_LUCI_LANG_zh_Hans=y
        
        # åªå®‰è£… PassWall å’Œ OpenClash
        CONFIG_PACKAGE_luci-app-passwall=y
        CONFIG_PACKAGE_luci-app-openclash=y
        
        # å»é™¤ä¸éœ€è¦çš„é»˜è®¤è½¯ä»¶åŒ…
        # CONFIG_PACKAGE_luci-app-ddns is not set
        # CONFIG_PACKAGE_luci-app-upnp is not set
        # CONFIG_PACKAGE_luci-app-vlmcsd is not set
        # CONFIG_PACKAGE_luci-app-vsftpd is not set
        # CONFIG_PACKAGE_luci-app-arpbind is not set
        # CONFIG_PACKAGE_luci-app-autoreboot is not set
        # CONFIG_PACKAGE_luci-app-filetransfer is not set
        # CONFIG_PACKAGE_luci-app-turboacc is not set
        # CONFIG_PACKAGE_luci-app-accesscontrol is not set
        # CONFIG_PACKAGE_luci-app-nlbwmon is not set
        # CONFIG_PACKAGE_luci-app-wol is not set
        EOF
        
        make defconfig
        
    - name: ä¸‹è½½ç¼–è¯‘ä¾èµ–
      run: |
        cd $GITHUB_WORKSPACE/immortalwrt
        make download -j16
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        echo "ä¸‹è½½åç£ç›˜ç©ºé—´ï¼š"
        df -hT $GITHUB_WORKSPACE
        
    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd $GITHUB_WORKSPACE/immortalwrt
        echo "å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨ $(nproc) çº¿ç¨‹"
        make -j$(nproc) || make -j1 V=s
        echo "ç¼–è¯‘å®Œæˆï¼Œå½“å‰ç£ç›˜ç©ºé—´ï¼š"
        df -hT $GITHUB_WORKSPACE
        
    - name: æ£€æŸ¥ç¼–è¯‘äº§ç‰©
      run: |
        cd $GITHUB_WORKSPACE/immortalwrt
        echo "ç¼–è¯‘äº§ç‰©åˆ—è¡¨ï¼š"
        ls -lh bin/targets/armvirt/64/
        
    - name: ä¸Šä¼  ARMv8 åº•åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-armvirt-64-rootfs
        path: ${{ github.workspace }}/immortalwrt/bin/targets/armvirt/64/*rootfs.tar.gz
        compression-level: 0
        retention-days: 7
        
  package:
    needs: build
    runs-on: ubuntu-22.04
    
    steps:
    - name: åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install wget git sudo
        sudo timedatectl set-timezone "$TZ"
        
    - name: æ£€å‡ºæ‰“åŒ…è„šæœ¬
      uses: actions/checkout@v4
      with:
        repository: ophub/amlogic-s9xxx-openwrt
        
    - name: ä¸‹è½½ç¼–è¯‘äº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: openwrt-armvirt-64-rootfs
        path: openwrt
        
    - name: æ£€æŸ¥ä¸‹è½½çš„æ–‡ä»¶
      run: |
        echo "ä¸‹è½½çš„æ–‡ä»¶åˆ—è¡¨ï¼š"
        ls -lh openwrt/
        
    - name: æ‰“åŒ… N1 å›ºä»¶
      run: |
        sudo chmod +x make
        sudo ./make -d -b s905d -k ${{ github.event.inputs.kernel_version }}
        
    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      run: |
        cd out
        echo "æ‰“åŒ…äº§ç‰©åˆ—è¡¨ï¼š"
        ls -lh
        
        # å‹ç¼© img æ–‡ä»¶
        for file in *.img; do
          if [ -f "$file" ]; then
            echo "å‹ç¼© $file"
            gzip "$file"
          fi
        done
        
        echo "å‹ç¼©åæ–‡ä»¶åˆ—è¡¨ï¼š"
        ls -lh
        echo "PACKAGED_OUTPUTPATH=$PWD" >> $GITHUB_ENV
        
    - name: ç”Ÿæˆ Release æ ‡ç­¾
      id: tag
      run: |
        echo "release_tag=ImmortalWrt-N1-k${{ github.event.inputs.kernel_version }}-$(date +%Y%m%d-%H%M)" >> $GITHUB_OUTPUT
        echo "release_date=$(date +"%Yå¹´%mæœˆ%dæ—¥ %H:%M")" >> $GITHUB_OUTPUT
        
    - name: ä¸Šä¼ å›ºä»¶åˆ° Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        name: ImmortalWrt N1 å›ºä»¶ - å†…æ ¸ ${{ github.event.inputs.kernel_version }}
        body: |
          ## ImmortalWrt æ–è®¯ N1 å›ºä»¶
          
          ### å›ºä»¶ä¿¡æ¯
          - ğŸ”§ å†…æ ¸ç‰ˆæœ¬: ${{ github.event.inputs.kernel_version }}
          - ğŸ“… ç¼–è¯‘æ—¶é—´: ${{ steps.tag.outputs.release_date }}
          - ğŸ¯ è®¾å¤‡å‹å·: æ–è®¯ N1 (S905D)
          - ğŸ“¦ å›ºä»¶ç±»å‹: ç²¾ç®€ç‰ˆ (ä»…åŒ…å« PassWall + OpenClash)
          
          ### é»˜è®¤é…ç½®
          - ğŸŒ é»˜è®¤ IP: `192.168.1.1` æˆ– `immortalwrt.lan`
          - ğŸ‘¤ ç”¨æˆ·å: `root`
          - ğŸ”‘ å¯†ç : æ—  (é¦–æ¬¡ç™»å½•éœ€è®¾ç½®)
          
          ### åˆ·æœºæ–¹å¼
          1. è§£å‹ `.img.gz` æ–‡ä»¶å¾—åˆ° `.img` é•œåƒ
          2. ä½¿ç”¨å·¥å…·(å¦‚ balenaEtcher/Rufus)å°†é•œåƒå†™å…¥ U ç›˜
          3. å°† U ç›˜æ’å…¥ N1,ä» U ç›˜å¯åŠ¨
          4. ç³»ç»Ÿå¯åŠ¨åæ‰§è¡Œ `armbian-install` å†™å…¥ EMMC
          
          ### å·²å®‰è£…æ’ä»¶
          - âœ… PassWall (ç§‘å­¦ä¸Šç½‘)
          - âœ… OpenClash (ä»£ç†å·¥å…·)
          - âœ… ä¸­æ–‡ç•Œé¢
          - âœ… SSL æ”¯æŒ
        files: ${{ env.PACKAGED_OUTPUTPATH }}/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
