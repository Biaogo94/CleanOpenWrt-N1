name: Build ImmortalWrt for Phicomm N1

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'å†…æ ¸ç‰ˆæœ¬ (æ¨è 6.1)'
        required: true
        default: '6.1'
        type: choice
        options:
          - '5.15'
          - '6.1'

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: æœ€å¤§åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 1024
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        
    - name: æ£€æŸ¥åˆå§‹ç£ç›˜ç©ºé—´
      run: |
        echo "åˆå§‹ç£ç›˜ç©ºé—´ï¼š"
        df -hT
        
    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
        git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
        libmpc-dev libmpfr-dev libncurses5-dev libreadline-dev libssl-dev libtool lrzsz \
        mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip libpython3-dev qemu-utils \
        rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        
    - name: å…‹éš† ImmortalWrt æºç 
      run: |
        git clone -b openwrt-23.05 --single-branch --filter=blob:none https://github.com/immortalwrt/immortalwrt
        
    - name: æ·»åŠ  PassWall æº
      run: |
        cd immortalwrt
        cat >> feeds.conf.default <<EOF
        src-git passwall_packages https://github.com/xiaorouji/openwrt-passwall-packages.git;main
        src-git passwall https://github.com/xiaorouji/openwrt-passwall.git;main
        EOF
        
    - name: æ›´æ–°å’Œå®‰è£… feeds
      run: |
        cd immortalwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: æ·»åŠ  OpenClash
      run: |
        cd immortalwrt
        mkdir -p package/luci-app-openclash
        cd package/luci-app-openclash
        git init
        git remote add -f origin https://github.com/vernesong/OpenClash.git
        git config core.sparsecheckout true
        echo "luci-app-openclash" >> .git/info/sparse-checkout
        git pull --depth 1 origin master
        
    - name: ç”Ÿæˆ .config é…ç½®æ–‡ä»¶
      run: |
        cd immortalwrt
        cat > .config <<EOF
        CONFIG_TARGET_armvirt=y
        CONFIG_TARGET_armvirt_64=y
        CONFIG_TARGET_armvirt_64_Default=y
        CONFIG_TARGET_ROOTFS_TARGZ=y
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-ssl-openssl=y
        CONFIG_LUCI_LANG_zh_Hans=y
        CONFIG_PACKAGE_luci-app-passwall=y
        CONFIG_PACKAGE_luci-app-openclash=y
        EOF
        
        # å…³é”®æ­¥éª¤:å…ˆ defconfig å†è¿½åŠ ç¦ç”¨é¡¹
        make defconfig
        
        # è¿½åŠ ç¦ç”¨ä¸éœ€è¦çš„åŒ…
        cat >> .config <<EOF
        # CONFIG_PACKAGE_luci-app-ddns is not set
        # CONFIG_PACKAGE_luci-app-upnp is not set
        # CONFIG_PACKAGE_luci-app-vlmcsd is not set
        # CONFIG_PACKAGE_luci-app-vsftpd is not set
        # CONFIG_PACKAGE_luci-app-arpbind is not set
        # CONFIG_PACKAGE_luci-app-autoreboot is not set
        # CONFIG_PACKAGE_luci-app-filetransfer is not set
        # CONFIG_PACKAGE_luci-app-turboacc is not set
        # CONFIG_PACKAGE_luci-app-accesscontrol is not set
        # CONFIG_PACKAGE_luci-app-nlbwmon is not set
        # CONFIG_PACKAGE_luci-app-wol is not set
        EOF
        
        make defconfig
        
    - name: éªŒè¯ç›®æ ‡æ¶æ„
      run: |
        cd immortalwrt
        echo "=== æ£€æŸ¥ .config ä¸­çš„ç›®æ ‡æ¶æ„ ==="
        grep "^CONFIG_TARGET" .config || echo "æœªæ‰¾åˆ° TARGET é…ç½®"
        echo "=== ç¡®è®¤å¿…é¡»æ˜¯ armvirt/64 ==="
        
    - name: ä¸‹è½½ç¼–è¯‘ä¾èµ–
      run: |
        cd immortalwrt
        make download -j16 V=s
        find dl -size -1024c -exec rm -f {} \;
        
    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd immortalwrt
        echo "å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨ $(nproc) çº¿ç¨‹"
        make -j$(nproc) V=s || make -j1 V=s
        
    - name: æ£€æŸ¥ç¼–è¯‘äº§ç‰©
      run: |
        cd immortalwrt
        echo "=== ç¼–è¯‘äº§ç‰©ç›®å½• ==="
        ls -lh bin/targets/
        echo "=== armvirt/64 ç›®å½•å†…å®¹ ==="
        ls -lh bin/targets/armvirt/64/ || echo "é”™è¯¯ï¼šarmvirt/64 ç›®å½•ä¸å­˜åœ¨ï¼"
        
    - name: ä¸Šä¼  ARMv8 åº•åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-armvirt-64-rootfs
        path: immortalwrt/bin/targets/armvirt/64/*rootfs.tar.gz
        compression-level: 0
        retention-days: 7
        if-no-files-found: error
        
  package:
    needs: build
    runs-on: ubuntu-22.04
    
    steps:
    - name: åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install wget git sudo gzip
        sudo timedatectl set-timezone "$TZ"
        
    - name: æ£€å‡ºæ‰“åŒ…è„šæœ¬
      uses: actions/checkout@v4
      with:
        repository: ophub/amlogic-s9xxx-openwrt
        
    - name: ä¸‹è½½ç¼–è¯‘äº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: openwrt-armvirt-64-rootfs
        path: openwrt-armvirt
        
    - name: æ£€æŸ¥ä¸‹è½½çš„æ–‡ä»¶
      run: |
        echo "=== ä¸‹è½½çš„å›ºä»¶æ–‡ä»¶ ==="
        ls -lh openwrt-armvirt/
        
    - name: æ‰“åŒ… N1 å›ºä»¶
      run: |
        sudo chmod +x make
        sudo ./make -d -b s905d -k ${{ github.event.inputs.kernel_version }} openwrt-armvirt/*rootfs.tar.gz
        
    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      run: |
        cd out
        echo "=== æ‰“åŒ…ç”Ÿæˆçš„å›ºä»¶ ==="
        ls -lh
        
        # å‹ç¼© img æ–‡ä»¶
        for file in *.img; do
          if [ -f "$file" ]; then
            echo "æ­£åœ¨å‹ç¼©: $file"
            gzip -9 "$file"
          fi
        done
        
        echo "=== æœ€ç»ˆå›ºä»¶åˆ—è¡¨ ==="
        ls -lh
        echo "PACKAGED_OUTPUTPATH=$PWD" >> $GITHUB_ENV
        
    - name: ç”Ÿæˆ Release ä¿¡æ¯
      id: tag
      run: |
        echo "release_tag=ImmortalWrt-N1-k${{ github.event.inputs.kernel_version }}-$(date +%Y%m%d-%H%M)" >> $GITHUB_OUTPUT
        echo "release_date=$(date +'%Yå¹´%mæœˆ%dæ—¥ %H:%M')" >> $GITHUB_OUTPUT
        
    - name: ä¸Šä¼ å›ºä»¶åˆ° Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        name: ImmortalWrt N1 å›ºä»¶ - å†…æ ¸ ${{ github.event.inputs.kernel_version }}
        body: |
          ## ğŸ“¦ ImmortalWrt æ–è®¯ N1 å›ºä»¶
          
          ### å›ºä»¶ä¿¡æ¯
          - ğŸ”§ **å†…æ ¸ç‰ˆæœ¬**: ${{ github.event.inputs.kernel_version }}
          - ğŸ“… **ç¼–è¯‘æ—¶é—´**: ${{ steps.tag.outputs.release_date }}
          - ğŸ¯ **è®¾å¤‡å‹å·**: æ–è®¯ N1 (Amlogic S905D)
          - ğŸ“¦ **å›ºä»¶ç±»å‹**: ç²¾ç®€ç‰ˆ (ä»… PassWall + OpenClash)
          
          ### é»˜è®¤é…ç½®
          - ğŸŒ **é»˜è®¤ IP**: `192.168.1.1` æˆ– `immortalwrt.lan`
          - ğŸ‘¤ **ç”¨æˆ·å**: `root`
          - ğŸ”‘ **å¯†ç **: æ—  (é¦–æ¬¡ç™»å½•éœ€è®¾ç½®)
          
          ### åˆ·æœºæ­¥éª¤
          1. è§£å‹ `.img.gz` æ–‡ä»¶
          2. ä½¿ç”¨ balenaEtcher/Rufus å†™å…¥ U ç›˜
          3. U ç›˜æ’å…¥ N1,ä» U ç›˜å¯åŠ¨
          4. æ‰§è¡Œ `armbian-install` å†™å…¥ EMMC
          
          ### å·²å®‰è£…æ’ä»¶
          - âœ… PassWall (ç§‘å­¦ä¸Šç½‘)
          - âœ… OpenClash (ä»£ç†å·¥å…·)
          - âœ… ä¸­æ–‡ç•Œé¢
          - âœ… SSL æ”¯æŒ
        files: ${{ env.PACKAGED_OUTPUTPATH }}/*.img.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
