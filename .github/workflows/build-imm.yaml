name: Build ImmortalWrt for Phicomm N1

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'å†…æ ¸ç‰ˆæœ¬'
        required: true
        default: '6.1'
        type: choice
        options:
          - '5.15'
          - '6.1'

# å…³é”®ä¿®å¤: æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write
  actions: read

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: æœ€å¤§åŒ–ç£ç›˜ç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 1024
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        
    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt-get update -qq
        sudo apt-get install -qq ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
        git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
        libmpc-dev libmpfr-dev libncurses5-dev libreadline-dev libssl-dev libtool lrzsz \
        mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip libpython3-dev qemu-utils \
        rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
        sudo apt-get autoremove --purge -y
        sudo apt-get clean
        sudo timedatectl set-timezone "$TZ"
        
    - name: å…‹éš† ImmortalWrt æºç 
      run: |
        git clone -b openwrt-23.05 --single-branch --filter=blob:none https://github.com/immortalwrt/immortalwrt
        
    - name: æ·»åŠ è‡ªå®šä¹‰ feeds æº
      run: |
        cd immortalwrt
        cat >> feeds.conf.default <<EOF
        src-git passwall_packages https://github.com/xiaorouji/openwrt-passwall-packages.git;main
        src-git passwall https://github.com/xiaorouji/openwrt-passwall.git;main
        EOF
        
    - name: æ›´æ–°å’Œå®‰è£… feeds
      run: |
        cd immortalwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: æ·»åŠ  OpenClash
      run: |
        cd immortalwrt/package
        git clone --depth=1 https://github.com/vernesong/OpenClash.git
        mv OpenClash/luci-app-openclash ./
        rm -rf OpenClash
        
    - name: ç”Ÿæˆé…ç½®æ–‡ä»¶
      run: |
        cd immortalwrt
        rm -f .config .config.old
        
        cat > .config <<'EOF'
        CONFIG_TARGET_armsr=y
        CONFIG_TARGET_armsr_armv8=y
        CONFIG_TARGET_armsr_armv8_DEVICE_generic=y
        CONFIG_TARGET_KERNEL_PARTSIZE=64
        CONFIG_TARGET_ROOTFS_PARTSIZE=960
        CONFIG_TARGET_ROOTFS_TARGZ=y
        
        # LuCI
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-ssl-openssl=y
        CONFIG_LUCI_LANG_zh_Hans=y
        
        # å¿…è£…æ’ä»¶
        CONFIG_PACKAGE_luci-app-passwall=y
        CONFIG_PACKAGE_luci-app-openclash=y
        
        # ç§»é™¤é»˜è®¤åº”ç”¨
        # CONFIG_PACKAGE_luci-app-ddns is not set
        # CONFIG_PACKAGE_luci-app-upnp is not set
        # CONFIG_PACKAGE_luci-app-vlmcsd is not set
        # CONFIG_PACKAGE_luci-app-vsftpd is not set
        # CONFIG_PACKAGE_luci-app-arpbind is not set
        # CONFIG_PACKAGE_luci-app-autoreboot is not set
        # CONFIG_PACKAGE_luci-app-filetransfer is not set
        # CONFIG_PACKAGE_luci-app-turboacc is not set
        # CONFIG_PACKAGE_luci-app-accesscontrol is not set
        # CONFIG_PACKAGE_luci-app-nlbwmon is not set
        # CONFIG_PACKAGE_luci-app-wol is not set
        # CONFIG_PACKAGE_luci-app-zerotier is not set
        EOF
        
        make defconfig
        
    - name: ç¡®è®¤ç›®æ ‡å¹³å°
      run: |
        cd immortalwrt
        echo "===== å½“å‰ç¼–è¯‘ç›®æ ‡ ====="
        grep "^CONFIG_TARGET" .config | head -20
        
    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        cd immortalwrt
        make download -j16
        find dl -size -1024c -exec rm -f {} \;
        
    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd immortalwrt
        echo "ä½¿ç”¨ $(nproc) ä¸ªCPUæ ¸å¿ƒç¼–è¯‘"
        make -j$(($(nproc) + 1)) || make -j1 V=s
        
    - name: æ£€æŸ¥ç¼–è¯‘ç»“æœ
      run: |
        cd immortalwrt
        echo "===== ç¼–è¯‘äº§ç‰© ====="
        ls -lh bin/targets/armsr/armv8/
        
    - name: ä¸Šä¼ å›ºä»¶åˆ° artifact
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-armsr-rootfs
        path: immortalwrt/bin/targets/armsr/armv8/*rootfs.tar.gz
        if-no-files-found: error
        retention-days: 7
        
  package:
    needs: build
    runs-on: ubuntu-22.04
    # å…³é”®ä¿®å¤: jobçº§åˆ«æƒé™é…ç½®
    permissions:
      contents: write
    
    steps:
    - name: ä¸‹è½½ç¼–è¯‘å¥½çš„å›ºä»¶
      uses: actions/download-artifact@v4
      with:
        name: immortalwrt-armsr-rootfs
        path: openwrt-armsr
        
    - name: éªŒè¯ä¸‹è½½çš„å›ºä»¶
      run: |
        echo "===== å›ºä»¶æ–‡ä»¶ ====="
        ls -lh openwrt-armsr/
        
    - name: æ‰“åŒ… N1 å›ºä»¶
      uses: ophub/amlogic-s9xxx-openwrt@main
      with:
        openwrt_path: openwrt-armsr/*rootfs.tar.gz
        openwrt_board: s905d
        openwrt_kernel: ${{ github.event.inputs.kernel_version }}
        auto_kernel: true
        kernel_repo: ophub/kernel
        gh_token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: æ£€æŸ¥æ‰“åŒ…ç»“æœ
      run: |
        echo "===== æ‰“åŒ…åçš„å›ºä»¶ ====="
        ls -lh ${{ env.PACKAGED_OUTPUTPATH }}/
        
    - name: ç”Ÿæˆ Release ä¿¡æ¯
      id: release_info
      run: |
        echo "tag=ImmortalWrt-N1-k${{ github.event.inputs.kernel_version }}-$(date +%Y%m%d-%H%M)" >> $GITHUB_OUTPUT
        echo "date=$(date +'%Yå¹´%mæœˆ%dæ—¥ %H:%M')" >> $GITHUB_OUTPUT
        
    - name: ä¸Šä¼ å›ºä»¶åˆ° Releases
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.release_info.outputs.tag }}
        name: ImmortalWrt æ–è®¯N1 å›ºä»¶ - å†…æ ¸ ${{ github.event.inputs.kernel_version }}
        body: |
          ## ğŸ“¦ ImmortalWrt æ–è®¯N1 ç²¾ç®€å›ºä»¶
          
          ### å›ºä»¶ä¿¡æ¯
          - ğŸ”§ **å†…æ ¸ç‰ˆæœ¬**: ${{ github.event.inputs.kernel_version }}
          - ğŸ“… **ç¼–è¯‘æ—¶é—´**: ${{ steps.release_info.outputs.date }}
          - ğŸ¯ **è®¾å¤‡å‹å·**: æ–è®¯N1 (Amlogic S905D)
          - ğŸ“¦ **å›ºä»¶ç±»å‹**: ç²¾ç®€ç‰ˆ
          
          ### å·²å®‰è£…æ’ä»¶
          - âœ… PassWall (ç§‘å­¦ä¸Šç½‘)
          - âœ… OpenClash (ä»£ç†å·¥å…·)
          - âœ… ä¸­æ–‡ç•Œé¢
          - âœ… SSL æ”¯æŒ
          
          ### é»˜è®¤é…ç½®
          - ğŸŒ **é»˜è®¤ IP**: `192.168.1.1` æˆ– `immortalwrt.lan`
          - ğŸ‘¤ **ç”¨æˆ·å**: `root`
          - ğŸ”‘ **å¯†ç **: æ—  (é¦–æ¬¡ç™»å½•éœ€è®¾ç½®)
          
          ### åˆ·æœºæ–¹æ³•
          1. è§£å‹ä¸‹è½½çš„ `.img.gz` æ–‡ä»¶
          2. ä½¿ç”¨ balenaEtcher æˆ– Rufus å°† `.img` å†™å…¥ U ç›˜
          3. å°† U ç›˜æ’å…¥æ–è®¯N1,ä» U ç›˜å¯åŠ¨
          4. ç³»ç»Ÿå¯åŠ¨å,æ‰§è¡Œ `armbian-install` å‘½ä»¤å†™å…¥ EMMC
          
          ### æ³¨æ„äº‹é¡¹
          - å¦‚éœ€é™çº§,è¯·å…ˆåˆ·å›å®˜æ–¹å›ºä»¶ V2.22 æˆ–æ›´ä½ç‰ˆæœ¬
          - é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦ç­‰å¾… 1-2 åˆ†é’Ÿ
          - å»ºè®®ä½¿ç”¨æœ‰çº¿ç½‘ç»œè¿›è¡Œåˆå§‹é…ç½®
        files: ${{ env.PACKAGED_OUTPUTPATH }}/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
